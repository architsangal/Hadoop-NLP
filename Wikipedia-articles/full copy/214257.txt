In computing, a stateful firewall (any firewall that performs stateful packet inspection (SPI) or stateful inspection) is a firewall that keeps track of the state of network connections (such as TCP streams, UDP communication) traveling across it. The firewall is programmed to distinguish legitimate packets for different types of connections. Only packets matching a known active connection will be allowed by the firewall; others will be rejected. [ History ] Before the advent of stateful firewalls, a stateless firewall, a firewall that treats each network frame (or packet ) in isolation, was normal. Such packet filter s operate at the Network Layer (layer 3) and function more efficiently because they only look at the header part of a packet. A drawback of pure packet filters is that they are stateless; they have no memory of previous packets which makes them vulnerable to spoofing attack s. Such a firewall has no way of knowing if any given packet is part of an existing connection, is trying to establish a new connection, or is just a rogue packet. Modern firewalls are connection-aware (or state-aware), offering network administrators finer-grained control of network traffic. The classic example of a network operation that may fail with a stateless firewall is the File Transfer Protocol (FTP). By design, such protocols need to be able to open connections to arbitrary high ports to function properly. Since a stateless firewall has no way of knowing that the packet destined to the protected network (to some host&apos;s destination port 4970, for example) is part of a legitimate FTP session, it will drop the packet. Stateful firewalls solve this problem by maintaining a table of open connections and intelligently associating new connection requests with existing legitimate connections. The invention of stateful firewall is usually credited to Nir Zuk and his team at Check Point in the mid-1990s. [ TechWeb Who Invented the Firewall? 2008-01-15 http://www.darkreading.com/security/management/showArticle.jhtml?articleID%3D208803808 ] [ Check Point Check Point Software Technologies Ltd. Awarded Patent For Stateful Inspection Technology 1997-03-17 2010-03-04url=http://www.checkpoint.com/press/1997/patent2.html ] Early attempts at producing firewalls operated at the Application Layer, which is the very top of the seven-layer OSI model. This method required exorbitant amounts of computing power and is rarely used in modern implementations. [ March 2011 ] [ Description ] A stateful firewall is able to hold significant attributes of each connection in memory, from start to finish. These attributes, which are collectively known as the state of the connection, may include such details as the IP addresses and ports involved in the connection and the sequence numbers of the packets traversing the connection.The most CPU intensive checking is performed at the time of setup of the connection. All packets after that (for that session) are processed rapidly because it is simple and fast to determine whether it belongs to an existing, pre-screened session. Once the session has ended, its entry in the state-table is discarded. The stateful firewall depends on the three-way handshake sometimes described as &quot; SYN,SYN-ACK,ACK &quot; (showing the order of SYNchronization bit and ACKnowledge bit use) of the TCP protocol when the protocol being used is TCP; when the protocol is UDP, the stateful firewall does not depend on anything related to TCP.When a client initiates a new connection, it sends a packet with the SYN bit set in the packet header. All packets with the SYN bit set are considered by the firewall as NEW connections. If the service which the client has requested is available on the server, the service will reply to the SYN packet with a packet in which both the SYN and the ACK bit are set. The client will then respond with a packet in which only the ACK bit is set, and the connection will enter the ESTABLISHED state. Such a firewall will pass all outgoing packets through but will only allow incoming packets if they are part of an ESTABLISHED connection, ensuring that hacker s cannot start unsolicited connections with the protected machine. In order to prevent the state table from filling up, sessions will time out if no traffic has passed for a certain period.These stale connections are removed from the state table. Many applications therefore send keepalive messages periodically in order to stop a firewall from dropping the connection during periods of no user-activity, though some firewalls can be instructed to send these messages for applications. Many stateful firewalls are able to track the state of flows in connectionless protocols. UDP hole punching is the technique associated with UDP.Such sessions usually get the ESTABLISHED state immediately after the first packet is seen by the firewall.Sessions in connectionless protocols can only end by time-out. By keeping track of the connection state, stateful firewalls provide added efficiency in terms of packet inspection.This is because for existing connections the firewall need only check the state table, instead of checking the packet against the firewall&apos;s rule set, which can be extensive.Also, the concept of deep packet inspection is unrelated to stateful firewalls, because of its stateful feature, which checks incoming traffic against its state table first instead of jumping to the firewall&apos;s rule set. In this case if the state table is matched, then it doesn&apos;t need deep packet inspection. Stateful packet inspection is typically achieved by using ASIC -accelerated appliances that are specifically engineered to handle Application Layer transactions. [ March 2011 ] [ Application-level filters ] [ Application firewall ] However, packet filtering alone is not regarded as providing enough protection. In order to effectively block peer-to-peer -related network traffic, what is needed is a firewall that does application filtering, which can be regarded as an extension to stateful packet inspection. Stateful packet inspection can determine what type of protocol is being sent over each port, but application-level filters look at what a protocol is being used for. For example, an application-level filter might be able to tell the difference between HTTP traffic used to access a Web page and HTTP traffic used for file sharing, whereas a firewall that is only performing packet filtering would treat all HTTP traffic equally. Application layer firewall s differ from stateful packet-filtering and circuit-level gateways in several ways. Application-layer firewalls support multiple application proxies on a single firewall. The proxies sit between the client and server, passing data between the two endpoints. Suspicious data is dropped and the client and server never communicate directly with each other. Because application-level proxies are application-aware, the proxies can more easily handle complex protocols like H.323, which is used for videoconferencing and VoIP (Voice over IP). Application proxies can be transparent to the client and server, as no configuration is required on the client or the server; or can be non-transparent, letting the client and server address the proxy server directly. Transparency versus non-transparency is a matter of implementation and address hiding, rather than about security. [ Pitfalls ] [ Vulnerabilities ] There is a risk that vulnerabilities in individual protocol decoders could allow an attacker to gain control over the firewall. This concern highlights the need to keep firewall software updated. { Review of Tomato firewall &quot;...both L7-Filter and IPP2P are explicitly unmaintained. Given the steady stream of security updates for protocol dissectors in WireShark, your editor has a hard time believing that these other classifiers can be completely free of security issues. &quot; } Stateful firewalls also raise the possibility that individual hosts can be tricked into soliciting outside connections. This possibility can only be completely eliminated by auditing the host software. Some firewalls can be defeated in this way by simply viewing a web page (either with JavaScript enabled, or after clicking on a button). { Hacker pierces hardware firewalls with web page } [ See also ] Check Point VPN-1 Cisco ASA Computer security Cyberoam Endian Firewall FireWall-1 IPCop IPFire IPFilter ipfirewall Kerio WinRoute Firewall Monowall Netfilter Network layer firewall PF pfSense Vyatta [ References ] Category:Computer network security cs:Stavov√Ω firewall de:Stateful Packet Inspection pms:SPI pl:Stateful Packet Inspection